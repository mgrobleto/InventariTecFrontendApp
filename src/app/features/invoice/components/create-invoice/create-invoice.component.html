<!-- Header Section -->
<div class="invoice-header">
    <div class="header-left">
        <button mat-icon-button (click)="goBack()" class="back-button">
            <mat-icon>arrow_back</mat-icon>
        </button>
        <h1 class="page-title">Crear Factura</h1>
    </div>
    <div class="header-right">
        <a href="#" class="help-link">
            <mat-icon>help_outline</mat-icon>
            ¿Necesitas ayuda?
        </a>
    </div>
</div>

<!-- Split Screen Container -->
<div class="invoice-split-container">
    <!-- Left Side: Invoice Form -->
    <div class="invoice-form-section">
        <!-- Invoice Details Card -->
        <mat-card class="form-card">
            <mat-card-header>
                <mat-card-title>Detalles de la Factura</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <form [formGroup]="invoiceForm">
                    <!-- Client Selection -->
                    <div class="form-row customer-row">
                        <mat-form-field appearance="outline" class="flex-grow">
                            <mat-label>Enviar a</mat-label>
                            <mat-select formControlName="customer_name" (selectionChange)="getCustomerInfo($event.value)">
                                <mat-option *ngFor="let customer of customers" [value]="customer.id">
                                    {{customer.first_name + ' ' + customer.last_name}}
                                </mat-option>
                            </mat-select>
                            <mat-hint *ngIf="!customerDetail">Nombre del cliente</mat-hint>
                        </mat-form-field>
                        <button mat-stroked-button type="button" class="add-client-button" (click)="handleAddCustomerAction()">
                            <mat-icon>person_add</mat-icon>
                            Agregar Cliente
                        </button>
                    </div>

                    <div class="form-row" *ngIf="customerDetail && customerDetail[0]">
                        <mat-form-field appearance="outline" class="full-width">
                            <mat-label>Dirección</mat-label>
                            <input matInput [value]="getClientAddress() || 'Ingrese la dirección del cliente'" readonly>
                        </mat-form-field>
                    </div>

                    <!-- Invoice Number and Due Date -->
                    <div class="form-row">
                        <mat-form-field appearance="outline">
                            <mat-label>Número de Factura</mat-label>
                            <input matInput formControlName="invoice_number" readonly>
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                            <mat-label>Fecha de Vencimiento</mat-label>
                            <input matInput [matDatepicker]="dueDatePicker" formControlName="invoice_date" readonly>
                            <mat-datepicker-toggle matSuffix [for]="dueDatePicker"></mat-datepicker-toggle>
                            <mat-datepicker #dueDatePicker></mat-datepicker>
                        </mat-form-field>
                    </div>

                    <!-- Payment Type -->
                    <div class="form-row">
                        <mat-form-field appearance="outline" class="full-width">
                            <mat-label>Tipo de Pago</mat-label>
                            <mat-select formControlName="payment_type" required>
                                <mat-option *ngFor="let payment of payment_type" [value]="payment.id">
                                    {{payment.name}}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>
                </form>
            </mat-card-content>
        </mat-card>

        <!-- Item Details Card -->
        <mat-card class="form-card">
            <mat-card-header>
                <mat-card-title>Detalles del Artículo</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <form [formGroup]="invoiceForm">
                    <div class="form-row">
                        <mat-form-field appearance="outline">
                            <mat-label>Categoría</mat-label>
                            <mat-select formControlName="category" (selectionChange)="getProductsByCategory($event.value)">
                                <mat-option *ngFor="let category of productsCategories" [value]="category.id">
                                    {{category.name}}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="flex-grow">
                            <mat-label>Producto</mat-label>
                            <mat-select formControlName="product" (selectionChange)="getProductDetails($event.value)" [disabled]="!productsByCategorySelected || productsByCategorySelected.length === 0">
                                <mat-option *ngFor="let product of productsByCategorySelected" [value]="product.id">
                                    {{product.name}}
                                </mat-option>
                            </mat-select>
                            <mat-hint *ngIf="!invoiceForm.get('product')?.value">Seleccione un producto</mat-hint>
                        </mat-form-field>
                    </div>

                    <div class="form-row">
                        <mat-form-field appearance="outline" class="full-width">
                            <mat-label>Descripción</mat-label>
                            <input matInput formControlName="description" placeholder="Opcional">
                        </mat-form-field>
                    </div>

                    <div class="form-row">
                        <mat-form-field appearance="outline">
                            <mat-label>Cantidad</mat-label>
                            <input matInput type="number" formControlName="quantity" required (input)="setQuantity($event)" min="1">
                            <mat-error *ngIf="invoiceForm.controls['quantity'].touched && invoiceForm.controls['quantity'].invalid">
                                <span *ngIf="invoiceForm.controls['quantity'].errors?.['required']">Debe rellenar este campo</span>
                            </mat-error>
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                            <mat-label>Moneda</mat-label>
                            <mat-select formControlName="currency">
                                <mat-option value="NIO">NIO</mat-option>
                            </mat-select>
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                            <mat-label>Precio</mat-label>
                            <input matInput formControlName="cost_price_at_time" readonly>
                        </mat-form-field>
                    </div>

                    <div class="form-row">
                        <mat-form-field appearance="outline" class="flex-grow">
                            <mat-label>Subtotal</mat-label>
                            <input matInput formControlName="sale_price_at_time" readonly>
                        </mat-form-field>
                    </div>

                    <div class="add-item-section">
                        <button
                            mat-raised-button
                            class="add-item-button"
                            [disabled]="validateAddProduct()"
                            (click)="addProductToSaleList()">
                            <mat-icon>add</mat-icon>
                            Agregar Artículo
                        </button>
                    </div>
                </form>
            </mat-card-content>
        </mat-card>

        <!-- Products Basket -->
        <mat-card class="form-card" *ngIf="dataSource.length > 0">
            <mat-card-header>
                <mat-card-title>
                    <mat-icon>shopping_cart</mat-icon>
                    Canasta de Productos
                </mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div class="responsive-table">
                    <mat-table [dataSource]="dataSource" class="mat-elevation-z0">
                        <ng-container matColumnDef="Nombre">
                            <th mat-header-cell *matHeaderCellDef> Nombre </th>
                            <td mat-cell *matCellDef="let element"> 
                                <span *ngFor="let prod of productsByCategorySelected">
                                    <span *ngIf="prod.id === element.product">{{prod.name}}</span>
                                </span>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="Precio">
                            <th mat-header-cell *matHeaderCellDef> Precio </th>
                            <td mat-cell *matCellDef="let element"> {{element.cost_price_at_time | number:'1.2-2'}} </td>
                        </ng-container>

                        <ng-container matColumnDef="Cantidad">
                            <th mat-header-cell *matHeaderCellDef> Cantidad </th>
                            <td mat-cell *matCellDef="let element">
                                <input
                                    matInput
                                    type="number"
                                    min="1"
                                    class="cart-quantity"
                                    [(ngModel)]="element.quantity"
                                    [ngModelOptions]="{standalone: true}"
                                    (input)="updateCartItem(element)"
                                >
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="Total">
                            <th mat-header-cell *matHeaderCellDef> Total </th>
                            <td mat-cell *matCellDef="let element"> {{element.sale_price_at_time | number:'1.2-2'}} </td>
                        </ng-container>

                        <ng-container matColumnDef="Eliminar">
                            <th mat-header-cell *matHeaderCellDef> </th>
                            <td mat-cell *matCellDef="let element;let i = index" class="action-link"> 
                                <button mat-icon-button color="warn" matTooltip="Eliminar" (click)="handleDeleteAction(i, element)">
                                    <mat-icon>delete</mat-icon>
                                </button>
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                    </mat-table>
                </div>
            </mat-card-content>
        </mat-card>

        <!-- Draft Save Status -->
        <div class="draft-status" *ngIf="dataSource.length > 0">
            <mat-icon>save</mat-icon>
            <span>Borrador guardado hace 2 min</span>
        </div>
    </div>

    <!-- Right Side: Live Preview -->
    <div class="invoice-preview-section">
        <div class="preview-header">
            <h2>Vista Previa</h2>
        </div>
        
        <div class="preview-container" id="invoicePreview">
            <div class="preview-card">
                <!-- Company Logo/Info -->
                <div class="preview-company">
                    <div class="company-logo">
                        <img class="logo-image" [src]="previewLogoUrl" alt="Tecnorefili logo" *ngIf="previewLogoUrl; else logoInitial">
                        <ng-template #logoInitial>
                            <div class="logo-circle">
                                <span>{{getBusinessInitial()}}</span>
                            </div>
                        </ng-template>
                    </div>
                    <div class="company-info">
                        <h3 class="total-amount">C$ {{invoiceForm.get('total')?.value || '0.00' | number:'1.2-2'}}</h3>
                        <p class="company-name">Factura de {{getBusinessName()}}</p>
                    </div>
                </div>

                <!-- Invoice Details -->
                <div class="preview-details">
                    <div class="detail-row">
                        <span class="detail-label">Número de Factura:</span>
                        <span class="detail-value">{{invoiceForm.get('invoice_number')?.value || '---'}}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Fecha de creación:</span>
                        <span class="detail-value">{{invoiceForm.get('invoice_date')?.value || '---'}}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Vence:</span>
                        <span class="detail-value">{{invoiceForm.get('invoice_date')?.value || '---'}}</span>
                    </div>
                </div>

                <!-- Client Info -->
                <div class="preview-client">
                    <div class="client-row">
                        <span class="client-label">Para:</span>
                        <span class="client-value">{{getClientName() || 'Ingrese el nombre del cliente'}}</span>
                    </div>
                    <div class="client-row">
                        <span class="client-label">Dirección:</span>
                        <span class="client-value">{{getClientAddress() || 'Ingrese la dirección del cliente'}}</span>
                    </div>
                </div>

                <!-- Items Table -->
                <div class="preview-items" *ngIf="dataSource.length > 0">
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th>Descripción</th>
                                <th>Cant.</th>
                                <th>Monto</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let item of dataSource">
                                <td>
                                    <span *ngIf="item.description; else productName">{{item.description}}</span>
                                    <ng-template #productName>
                                        <span *ngFor="let prod of productsByCategorySelected">
                                            <span *ngIf="prod.id === item.product">{{prod.name}}</span>
                                        </span>
                                    </ng-template>
                                </td>
                                <td>{{item.quantity}}</td>
                                <td>C${{item.sale_price_at_time | number:'1.2-2'}}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Summary -->
                <div class="preview-summary">
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span>C$ {{totalAmount | number:'1.2-2'}}</span>
                    </div>
                    <div class="summary-row total-row">
                        <span>Total:</span>
                        <span>C$ {{invoiceForm.get('total')?.value || '0.00' | number:'1.2-2'}}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="preview-actions">
            <button mat-stroked-button (click)="cancelInvoice()" class="cancel-button">
                Cancelar
            </button>
            <button mat-raised-button [disabled]="isSubmitDisabled" (click)="submitAction()" class="send-button">
                Enviar Factura
            </button>
        </div>
    </div>
</div>


